version: '3.9'
services:
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    env_file:
      - .env
    environment:
      - PORT=${PORT:-4000}
      - AWS_REGION=${AWS_REGION}
      - S3_DATA_BUCKET=${S3_DATA_BUCKET}
      - S3_MODEL_BUCKET=${S3_MODEL_BUCKET}
      - AWS_PROFILE=${AWS_PROFILE}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
      - COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}
      - COGNITO_DOMAIN=${COGNITO_DOMAIN}
      - COGNITO_REDIRECT_URI=${COGNITO_REDIRECT_URI}
      - COGNITO_GOOGLE_IDP=${COGNITO_GOOGLE_IDP}
      - DOCUMENTDB_URI=${DOCUMENTDB_URI}
      - DOCUMENTDB_DB=${DOCUMENTDB_DB}
      - DOCUMENTDB_TLS_CA_FILE=${DOCUMENTDB_TLS_CA_FILE}
      - ALLOW_DEV_AUTH=${ALLOW_DEV_AUTH}
      - HUGGINGFACE_API_TOKEN=${HUGGINGFACE_API_TOKEN}
      - GCP_PROJECT=${GCP_PROJECT_ID:-$GCP_PROJECT}
      - GCS_BUCKET=${GCS_BUCKET}
    ports:
      - "${PORT:-4000}:4000"

  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
      args:
        NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE:-http://backend:4000}
        NEXT_PUBLIC_AWS_REGION: ${AWS_REGION}
        NEXT_PUBLIC_COGNITO_USER_POOL_ID: ${COGNITO_USER_POOL_ID}
        NEXT_PUBLIC_COGNITO_CLIENT_ID: ${COGNITO_CLIENT_ID}
        NEXT_PUBLIC_COGNITO_DOMAIN: ${COGNITO_DOMAIN}
        NEXT_PUBLIC_COGNITO_REDIRECT_URI: ${COGNITO_REDIRECT_URI}
        NEXT_PUBLIC_GOOGLE_IDP: ${COGNITO_GOOGLE_IDP}
    environment:
      - NEXT_PUBLIC_API_BASE=${NEXT_PUBLIC_API_BASE:-http://backend:4000}
      - NEXT_PUBLIC_AWS_REGION=${AWS_REGION}
      - NEXT_PUBLIC_COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
      - NEXT_PUBLIC_COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}
      - NEXT_PUBLIC_COGNITO_DOMAIN=${COGNITO_DOMAIN}
      - NEXT_PUBLIC_COGNITO_REDIRECT_URI=${COGNITO_REDIRECT_URI}
      - NEXT_PUBLIC_GOOGLE_IDP=${COGNITO_GOOGLE_IDP}
    ports:
      - "3000:3000"
    depends_on:
      - backend
