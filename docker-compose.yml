version: '3.9'
services:
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    env_file:
      - .env
    environment:
      - PORT=${PORT:-4000}
      - AWS_REGION=${AWS_REGION}
      - S3_DATA_BUCKET=${S3_DATA_BUCKET}
      - S3_MODEL_BUCKET=${S3_MODEL_BUCKET}
      - AWS_PROFILE=${AWS_PROFILE}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
      - COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}
      - COGNITO_DOMAIN=${COGNITO_DOMAIN}
      - COGNITO_REDIRECT_URI=${COGNITO_REDIRECT_URI}
      - COGNITO_GOOGLE_IDP=${COGNITO_GOOGLE_IDP}
      - DOCUMENTDB_URI=${DOCUMENTDB_URI}
      - DOCUMENTDB_DB=${DOCUMENTDB_DB}
      - DOCUMENTDB_TLS_CA_FILE=${DOCUMENTDB_TLS_CA_FILE}
      - ALLOW_DEV_AUTH=${ALLOW_DEV_AUTH}
      - HUGGINGFACE_API_TOKEN=${HUGGINGFACE_API_TOKEN}
      - GCP_PROJECT=${GCP_PROJECT_ID:-$GCP_PROJECT}
      - GCS_BUCKET=${GCS_BUCKET}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - GLOBAL_ADMIN_IDS=${GLOBAL_ADMIN_IDS}
      - JOB_FLAT_RATE_USD=${JOB_FLAT_RATE_USD:-50}
      - ORG_FREE_JOB_LIMIT=${ORG_FREE_JOB_LIMIT:-100}
      - DEFAULT_MANAGED_CLUSTER_URL=${DEFAULT_MANAGED_CLUSTER_URL}
      - DEFAULT_MANAGED_CLUSTER_TOKEN=${DEFAULT_MANAGED_CLUSTER_TOKEN}
      - DEFAULT_MANAGED_CLUSTER_PROVIDER=${DEFAULT_MANAGED_CLUSTER_PROVIDER:-huggingface}
      - PUBLIC_APP_URL=${PUBLIC_APP_URL:-http://localhost:3000}
      - PUBLIC_API_BASE_URL=${PUBLIC_API_BASE_URL:-http://localhost:4000}
    ports:
      - "${PORT:-4000}:4000"

  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
      args:
        BACKEND_INTERNAL_BASE: ${BACKEND_INTERNAL_BASE:-http://backend:4000}
        NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE:-}
        NEXT_PUBLIC_AWS_REGION: ${AWS_REGION}
        NEXT_PUBLIC_COGNITO_USER_POOL_ID: ${COGNITO_USER_POOL_ID}
        NEXT_PUBLIC_COGNITO_CLIENT_ID: ${COGNITO_CLIENT_ID}
        NEXT_PUBLIC_COGNITO_DOMAIN: ${COGNITO_DOMAIN}
        NEXT_PUBLIC_COGNITO_REDIRECT_URI: ${COGNITO_REDIRECT_URI}
        NEXT_PUBLIC_GOOGLE_IDP: ${COGNITO_GOOGLE_IDP}
        NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
    environment:
      - BACKEND_INTERNAL_BASE=${BACKEND_INTERNAL_BASE:-http://backend:4000}
      - NEXT_PUBLIC_API_BASE=${NEXT_PUBLIC_API_BASE:-}
      - NEXT_PUBLIC_AWS_REGION=${AWS_REGION}
      - NEXT_PUBLIC_COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
      - NEXT_PUBLIC_COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}
      - NEXT_PUBLIC_COGNITO_DOMAIN=${COGNITO_DOMAIN}
      - NEXT_PUBLIC_COGNITO_REDIRECT_URI=${COGNITO_REDIRECT_URI}
      - NEXT_PUBLIC_GOOGLE_IDP=${COGNITO_GOOGLE_IDP}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
    ports:
      - "3000:3000"
    depends_on:
      - backend

  docs:
    build:
      context: apps/docs
      dockerfile: Dockerfile
    command: npm run start
    environment:
      - CHOKIDAR_USEPOLLING=true
    ports:
      - "3050:3050"
