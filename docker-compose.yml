version: '3.9'
services:
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    env_file:
      - .env
    environment:
      - PORT=${PORT:-4000}
      - AWS_REGION=${AWS_REGION}
      - S3_DATA_BUCKET=${S3_DATA_BUCKET}
      - S3_MODEL_BUCKET=${S3_MODEL_BUCKET}
      - AWS_PROFILE=${AWS_PROFILE}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
      - COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}
      - HUGGINGFACE_API_TOKEN=${HUGGINGFACE_API_TOKEN}
      - GCP_PROJECT=${GCP_PROJECT_ID:-$GCP_PROJECT}
      - GCS_BUCKET=${GCS_BUCKET}
    ports:
      - "${PORT:-4000}:4000"

  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
      args:
        NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE:-http://backend:4000}
        NEXT_PUBLIC_AWS_REGION: ${AWS_REGION}
        NEXT_PUBLIC_COGNITO_USER_POOL_ID: ${COGNITO_USER_POOL_ID}
        NEXT_PUBLIC_COGNITO_CLIENT_ID: ${COGNITO_CLIENT_ID}
    environment:
      - NEXT_PUBLIC_API_BASE=${NEXT_PUBLIC_API_BASE:-http://backend:4000}
      - NEXT_PUBLIC_AWS_REGION=${AWS_REGION}
      - NEXT_PUBLIC_COGNITO_USER_POOL_ID=${COGNITO_USER_POOL_ID}
      - NEXT_PUBLIC_COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}
    ports:
      - "3000:3000"
    depends_on:
      - backend
